name: PR checks

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop, qa, main]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check || (echo "Run npm run format to fix" && exit 1)

      - name: Run tests
        run: npm test --silent

      - name: Validate commit messages
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          git log --format=%B origin/${{ github.head_ref }}..${{ github.sha }} | grep -qE '^[A-Za-z0-9-]+: .+' || (echo "Commit message validation failed" && exit 1)

      - name: Check for changeset files in PR commits
        run: |
          # Look for any changeset files added/modified in the PR
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          files=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }})
          echo "$files" | grep -q '\.changeset/' || (echo "No Changeset file found in PR commits. Please add one." && exit 1)

  generate-and-test-templates:
    runs-on: ubuntu-latest
    needs: pr-check
    strategy:
      matrix:
        template: [garry-frontend-template, garry-backend-template]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      - name: Install scaffold dev deps
        run: npm ci

      - name: Generate template (non-interactive)
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@github.com
        run: |
          if [ "${{ matrix.template }}" = "garry-frontend-template" ]; then
            node ./bin/cli.js --non-interactive --name ci-${{ matrix.template }} --type frontend --module ESM --yes --dry-run
          else
            node ./bin/cli.js --non-interactive --name ci-${{ matrix.template }} --type backend --module ESM --yes --dry-run
          fi

      - name: Cache generated project node_modules
        uses: actions/cache@v4
        with:
          path: ci-${{ matrix.template }}/node_modules
          key: ${{ runner.os }}-node-modules-${{ matrix.template }}-${{ hashFiles(format('ci-{0}/package-lock.json', matrix.template)) }}
          restore-keys: |
            ${{ runner.os }}-node-modules-${{ matrix.template }}-

      - name: Offline-install smoke test
        run: |
          echo "Attempting prefer-offline install for ci-${{ matrix.template }}"
          cd ci-${{ matrix.template }}
          npm ci --prefer-offline --no-audit --no-fund --silent || (echo "Offline install failed; cache miss or network required" && exit 1)
          if [ ! -d node_modules ]; then
            echo "node_modules not created during prefer-offline install"
            exit 1
          fi

      - name: Generate template (dry-run install check)
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@github.com
        run: |
          if [ "${{ matrix.template }}" = "garry-frontend-template" ]; then
            node ./bin/cli.js --non-interactive --name ci-dry-${{ matrix.template }} --type frontend --module ESM --yes --dry-run
          else
            node ./bin/cli.js --non-interactive --name ci-dry-${{ matrix.template }} --type backend --module ESM --yes --dry-run
          fi
          # Ensure dry-run did not produce node_modules
          if [ -d "ci-dry-${{ matrix.template }}/node_modules" ]; then
            echo "Dry-run unexpectedly created node_modules"
            ls -la "ci-dry-${{ matrix.template }}/node_modules" || true
            exit 1
          fi
          # Cleanup dry-run project
          rm -rf ci-dry-${{ matrix.template }}

      - name: Run generated project checks
        run: |
          cd ci-${{ matrix.template }}
          npm ci --silent
          npm run lint
          npm run format:check || (echo "Run npm run format to fix" && exit 1)
          npm run test:structure
          # If backend template, run DB sync & seed to verify DB scripts
          if [ "${{ matrix.template }}" = "garry-backend-template" ]; then
            echo "Running DB sync & seed for backend template..."
            npm run db:sync || (echo "db:sync failed" && exit 1)
            npm run db:seed || (echo "db:seed failed" && exit 1)
          fi
          npm test --silent
          # attempt a build if script exists
          if npm run | grep -q "build"; then
            npm run build
          fi
