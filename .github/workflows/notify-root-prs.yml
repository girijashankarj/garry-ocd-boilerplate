name: "Notify PRs (root)"

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [main, develop, qa]
    paths:
      - 'package.json'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/**'
      - 'bin/**'
      - 'scripts/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare env (title/url/user/branch & channel)
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV
          echo "PR_USER=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          if [ "${{ github.event.pull_request.base.ref }}" = "main" ] && [ -n "${{ secrets.SLACK_CHANNEL_MAIN }}" ]; then
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL_MAIN }}" >> $GITHUB_ENV
          elif [ "${{ github.event.pull_request.base.ref }}" = "develop" ] && [ -n "${{ secrets.SLACK_CHANNEL_DEV }}" ]; then
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL_DEV }}" >> $GITHUB_ENV
          elif [ "${{ github.event.pull_request.base.ref }}" = "qa" ] && [ -n "${{ secrets.SLACK_CHANNEL_QA }}" ]; then
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL_QA }}" >> $GITHUB_ENV
          else
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL }}" >> $GITHUB_ENV
          fi

      - name: Compute labels and Slack mention (jq)
        run: |
          PR_LABELS=$(jq -r '[.pull_request.labels[]?.name] | join(",")' "$GITHUB_EVENT_PATH") || PR_LABELS=""
          echo "PR_LABELS=$PR_LABELS" >> $GITHUB_ENV
          GH_USER=$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH" || echo "")
          SLACK_MENTION=""
          if [ -f .github/slack_user_map.json ] && [ -n "$GH_USER" ]; then
            SID=$(jq -r --arg gh "$GH_USER" '.github_username_to_slack_id[$gh] // empty' .github/slack_user_map.json)
            if [ -n "$SID" ]; then
              SLACK_MENTION="<@$SID>"
            fi
          fi
          echo "SLACK_MENTION=$SLACK_MENTION" >> $GITHUB_ENV
          echo "BODY=PR: $PR_TITLE\nAuthor: $PR_USER\nBranch: $BASE_BRANCH\nLabels: $PR_LABELS\nURL: $PR_URL" >> $GITHUB_ENV

      - name: Send Slack (bot + blocks via curl)
        if: secrets.SLACK_BOT_TOKEN && env.CHANNEL
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          CHANNEL: ${{ env.CHANNEL }}
        run: |
          set -euo pipefail
          if [ -z "${CHANNEL:-}" ]; then
            echo "no CHANNEL set; skipping"; exit 0
          fi
          PR_USER_URL="https://github.com/${PR_USER}"
          # build payload with jq to avoid YAML quoting issues
          jq -n --arg channel "$CHANNEL" --arg title "$PR_TITLE" --arg mention "$SLACK_MENTION" \
            --arg prurl "$PR_URL" --arg author "$PR_USER" --arg branch "$BASE_BRANCH" \
            --arg labels "$PR_LABELS" --arg repo "$GITHUB_REPOSITORY" \
            '{channel:$channel,blocks:[{type:"section",text:{type:"mrkdwn",text:("*New Pull Request* "+$mention+"\n*"+$title+"*")}}, {type:"section",fields:[{type:"mrkdwn",text:("*Author:*\n<"+("https://github.com/"+$author)+"|"+$author+">")},{type:"mrkdwn",text:("*Branch:*\n"+$branch)}]}, {type:"context",elements:[{type:"mrkdwn",text:("Labels: "+$labels)},{type:"mrkdwn",text:("Repository: "+$repo)}]}, {type:"actions",elements:[{type:"button",text:{type:"plain_text",text:"View PR"},url:$prurl}]}]}' \
            > /tmp/payload.json
          curl -s -X POST -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" -H "Content-type: application/json" --data @/tmp/payload.json https://slack.com/api/chat.postMessage || true

      - name: Send Teams (Adaptive Card)
        if: secrets.TEAMS_WEBHOOK
        uses: ./.github/actions/teams-notify
        with:
          webhook: ${{ secrets.TEAMS_WEBHOOK }}
          card: >-
            {"type":"message","attachments":[{"contentType":"application/vnd.microsoft.card.adaptive","content":{"$schema":"http://adaptivecards.io/schemas/adaptive-card.json","type":"AdaptiveCard","version":"1.2","body":[{"type":"TextBlock","size":"Medium","weight":"Bolder","text":"New Pull Request ${{ env.SLACK_MENTION }}"},{"type":"TextBlock","text":"${{ env.PR_TITLE }}","wrap":true},{"type":"FactSet","facts":[{"title":"Author","value":"${{ env.PR_USER }}