name: 'Notify PRs (root)'
on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [main, develop, qa]
    paths:
      - 'package.json'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/**'
      - 'bin/**'
      - 'scripts/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare env (title/url/user/branch & channel)
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV
          echo "PR_USER=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          if [ "${{ github.event.pull_request.base.ref }}" = "main" ] && [ -n "${{ secrets.SLACK_CHANNEL_MAIN }}" ]; then
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL_MAIN }}" >> $GITHUB_ENV
          elif [ "${{ github.event.pull_request.base.ref }}" = "develop" ] && [ -n "${{ secrets.SLACK_CHANNEL_DEV }}" ]; then
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL_DEV }}" >> $GITHUB_ENV
          elif [ "${{ github.event.pull_request.base.ref }}" = "qa" ] && [ -n "${{ secrets.SLACK_CHANNEL_QA }}" ]; then
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL_QA }}" >> $GITHUB_ENV
          else
            echo "CHANNEL=${{ secrets.SLACK_CHANNEL }}" >> $GITHUB_ENV
          fi

      - name: Compute labels and Slack mention (jq)
        run: |
          PR_LABELS=$(jq -r '[.pull_request.labels[]?.name] | join(",")' "$GITHUB_EVENT_PATH") || PR_LABELS=""
          echo "PR_LABELS=$PR_LABELS" >> $GITHUB_ENV
          GH_USER=$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH" || echo "")
          SLACK_MENTION=""
          if [ -f .github/slack_user_map.json ] && [ -n "$GH_USER" ]; then
            SID=$(jq -r --arg gh "$GH_USER" '.github_username_to_slack_id[$gh] // empty' .github/slack_user_map.json)
            if [ -n "$SID" ]; then
              SLACK_MENTION="<@$SID>"
            fi
          fi
          echo "SLACK_MENTION=$SLACK_MENTION" >> $GITHUB_ENV
          echo "BODY=PR: $PR_TITLE\nAuthor: $PR_USER\nBranch: $BASE_BRANCH\nLabels: $PR_LABELS\nURL: $PR_URL" >> $GITHUB_ENV

      - name: Send Slack (bot + blocks)
        if: secrets.SLACK_BOT_TOKEN && env.CHANNEL
        uses: slackapi/slack-github-action@v1
        with:
          payload: >-
            {"channel":"${{ env.CHANNEL }}","blocks":[{"type":"section","text":{"type":"mrkdwn","text":"*New Pull Request* ${{ env.SLACK_MENTION }}\n*${{ env.PR_TITLE }}*"}},{"type":"section","fields":[{"type":"mrkdwn","text":"*Author:*\n<https://github.com/${{ env.PR_USER }}|${{ env.PR_USER }}>"},{"type":"mrkdwn","text":"*Branch:*\n${{ env.BASE_BRANCH }}"}]},{"type":"context","elements":[{"type":"mrkdwn","text":"Labels: ${{ env.PR_LABELS }}"},{"type":"mrkdwn","text":"Repository: ${{ github.repository }}"}]},{"type":"actions","elements":[{"type":"button","text":{"type":"plain_text","text":"View PR"},"url":"${{ env.PR_URL }}"}]}]}
        
          env:
            SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Fallback: Send Slack via webhook
        if: secrets.SLACK_WEBHOOK
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: '{"text":"${{ env.BODY }}"}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Send Teams (Adaptive Card)
        if: secrets.TEAMS_WEBHOOK
        uses: ./.github/actions/teams-notify
        with:
          webhook: ${{ secrets.TEAMS_WEBHOOK }}
          card: >-
            {"type":"message","attachments":[{"contentType":"application/vnd.microsoft.card.adaptive","content":{"$schema":"http://adaptivecards.io/schemas/adaptive-card.json","type":"AdaptiveCard","version":"1.2","body":[{"type":"TextBlock","size":"Medium","weight":"Bolder","text":"New Pull Request ${{ env.SLACK_MENTION }}"},{"type":"TextBlock","text":"${{ env.PR_TITLE }}","wrap":true},{"type":"FactSet","facts":[{"title":"Author","value":"${{ env.PR_USER }}"},{"title":"Branch","value":"${{ env.BASE_BRANCH }}"},{"title":"Labels","value":"${{ env.PR_LABELS }}"}]}],"actions":[{"type":"Action.OpenUrl","title":"View PR","url":"${{ env.PR_URL }}"}]}}]}

      - name: Send WhatsApp (webhook)
        if: secrets.WHATSAPP_WEBHOOK
        run: |
          curl -s -X POST -H 'Content-type: application/json' --data "{\"message\": \"${{ env.PR_TITLE }} - ${{ env.PR_URL }}\"}" "${{ secrets.WHATSAPP_WEBHOOK }}" || true
