name: 'Sync Slack users'
on:
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Slack users
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          set -e
          if [ -z "$SLACK_BOT_TOKEN" ]; then
            echo "SLACK_BOT_TOKEN not provided"; exit 1
          fi
          curl -s -H "Authorization: Bearer $SLACK_BOT_TOKEN" "https://slack.com/api/users.list?limit=2000" -o /tmp/slack_users.json
          if ! jq -e '.ok' /tmp/slack_users.json >/dev/null; then
            echo "Slack API error"; cat /tmp/slack_users.json; exit 1
          fi
          # build email->slack_id mapping for users with profile.email
          jq -r '.members[] | select(.deleted==false) | select(.profile.email != null) | {email: .profile.email, id: .id}' /tmp/slack_users.json | jq -s 'reduce .[] as $item ({}; .[$item.email] = $item.id)' > .github/slack_user_map_from_slack.json
          echo "Written .github/slack_user_map_from_slack.json"

      - name: Commit mapping
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'chore: update slack user map'
          file_pattern: '.github/slack_user_map_from_slack.json'
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: github-actions@users.noreply.github.com
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge mapping into canonical `slack_user_map.json`
        run: |
          set -euo pipefail
          FROM=.github/slack_user_map_from_slack.json
          TO=.github/slack_user_map.json
          if [ ! -f "$FROM" ]; then
            echo "No generated mapping found; skipping merge"; exit 0
          fi
          if [ -f "$TO" ]; then
            jq -s '.[0] * .[1]' "$TO" "$FROM" > .github/slack_user_map.merged.json
          else
            cp "$FROM" .github/slack_user_map.merged.json
          fi
          mv .github/slack_user_map.merged.json "$TO"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$TO"
          git commit -m "chore: merge slack user map from Slack (workflow)" || echo "no changes to commit"
          git push || echo "push failed (maybe no permission)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
