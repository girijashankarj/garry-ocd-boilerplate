# Backend Project Documentation

Introduction
This document is the single source of truth for backend projects generated by the garry‑ocd scaffolder. It is written for managers, architects, engineers, QA, and DevOps to align on scope, standards, and delivery expectations.

## Contents
- Overview and scope
- Use cases
- File/folder structure
- Commands and scripts
- Configuration
- Architecture and data flow
- Security
- Logging
- API standards
- Testing strategy and structure
- Git workflow and quality gates
- CI (PR checks)
- Local developer workflow
- Do and don’t
- References
- Last updated

## Overview and scope
Purpose
- Provide a production‑ready, consistent backend baseline.

Scope
- Express + TypeScript.
- AJV validation.
- Sequelize example.

Out of scope
- Fullstack monorepo scaffolding.

## Use cases
- Rapid backend delivery with strict validation.
- Consistent API structure for teams.

## Use-case diagram (ASCII)
```
Actor: Developer -> (Scaffold Project) -> (Install Deps) -> (Run API)
Actor: QA        -> (Run Tests) -> (Validate API Responses)
Actor: DevOps    -> (Run CI) -> (Deploy Service)
```

## File/folder structure (ASCII)
```
my-api/
├── .github/workflows/pr-check.yml
├── config/
├── docs/
│   └── PROJECT-DOCS.md
├── scripts/
│   ├── precommit/
│   ├── db/
│   ├── inject-badge.js
│   └── verify-tests.js
├── src/
│   ├── apis/
│   ├── common/
│   ├── db/
│   ├── models/
│   └── utils/
├── tests/
│   ├── mock/
│   └── src/
├── .husky/
├── package.json
└── README.md
```

## Commands and scripts
Core scripts
- npm run dev
- npm run build
- npm run lint
- npm run format
- npm run test
- npm run test:structure
- npm run db:sync
- npm run db:seed

Hook scripts
- pre-commit runs lint-staged + changeset check + test:structure
- commit-msg enforces <ticket-number>: <message>

## Configuration
Required files
- config/theme.json
- config/client.json
- config/env.json

Rules
- No secrets in JSON files.
- Validate config at startup.

Example config (theme.json)
```
{
  "mode": "dark",
  "colors": { "primary": "#0ea5e9", "background": "#0b0b0b" }
}
```

Example config (client.json)
```
{
  "name": "Garry Client",
  "domain": "example.com",
  "supportEmail": "support@example.com",
  "locale": "en-US"
}
```

Example config (env.json)
```
{
  "PORT": "PORT",
  "DATABASE_URL": "DATABASE_URL",
  "LOG_LEVEL": "LOG_LEVEL"
}
```

Config loading flow (ASCII)
```
[env vars] + [config/*.json] -> [validated config] -> [app]
```

## Architecture and data flow
Flow
- router -> handler -> AJV validation -> business validation -> pre -> logic -> post -> response

Rules
- Use withWrap for handlers.
- No mutation of inputs.

ASCII flow
```
Router -> Handler -> AJV -> Business -> Pre -> Logic -> Post -> Response
```

## Security
- Validate all inputs.
- Avoid logging PII.
- Use env mapping JSON.

## Logging
Schema
- level, message, context, fileName, functionName, payload

Rules
- Use message keys from src/common/messages.
- Never log secrets or PII.
- Include operation name where possible.

Example
```
loggerError(ERROR_MESSAGES.DB, { table: 'users' }, OPERATIONS.USERS_CREATE, FILE_NAMES.USERS_HANDLER, 'createUser');
```

## API standards
Structure
- handlers, requestSchema, responseSchema, logic, preOperation, postOperation, validation, businessValidation, sql

Rules
- Wrap handlers with withWrap.
- Validation uses AJV.
- SQL strings only in sql.ts.

## Testing strategy and structure
Policy
- Every src file has a matching test in tests/src.
- tests/src mirrors src.
- Tests and mocks are linted/formatted and excluded from build output.

Coverage
- Minimum 70% across metrics.

Test types
- Unit tests for logic/utils
- Schema validation tests (AJV)
- DB tests with sqlite in-memory

Mocking
- External services mocked in jest.setup.js.
- Fixtures in tests/mock.

ASCII structure
```
src/path/file.ts -> tests/src/path/file.test.ts
```

Test case matrix (backend)
| ID | Area | Scope | Steps | Expected result |
| --- | --- | --- | --- | --- |
| BE-001 | API | Schema validation | POST invalid payload | 400 with validation error |
| BE-002 | API | Business validation | Break domain rule | 400 with business error |
| BE-003 | DB | Sync | Run `npm run db:sync` | Tables created |
| BE-004 | Logs | Logger schema | Trigger error path | Log includes level, message, context, file, function |
| BE-005 | Tests | Structure | Run `npm run test:structure` | Fails for missing tests |

## Risks and mitigations
Risks
- Unvalidated payloads reaching logic.
- Missing tests for new handlers.
- Secrets accidentally logged.

Mitigations
- AJV validation enforced in handlers.
- test:structure enforced in pre-commit and CI.
- Logging schema rules and code review.

## Git workflow and quality gates
Branch rules
- main, qa, develop
- feature/*, fix/*, hotfix/*, release/DD-MM-YYYY

Commit format
- <ticket-number>: <message>

Changesets
- Required for every commit.

## CI (PR checks)
Checks executed
- lint
- format:check
- test:structure
- tests

Failures
- Any failure blocks merge.

## Deployment
Target
- AWS preferred

Checklist
- Tests pass
- Config validated
- Secrets injected via env

## Deployment runbook (backend)
Pre-deploy
- npm install
- npm run build
- Verify env mapping

Deploy
- Deploy service to target environment
- Verify database connectivity

Post-deploy
- Smoke test health endpoint
- Validate logs for errors

## Acceptance test cases (backend)
Functional
- /health responds 200
- Validation rejects invalid payloads with 400

Quality
- npm run lint passes with zero warnings
- npm run test passes with coverage >= 70%
- npm run test:structure passes

Config
- env.json maps required variables
- Missing env vars fail at startup

## QA checklist
- Validate request schema errors return 400.
- Verify business validation paths.
- Confirm tests pass and coverage >= 70%.
- Ensure no lint warnings.

## DevOps checklist
- Ensure CI passes for PR.
- Validate env variables for deployment.
- Confirm logging output schema.
## Local developer workflow
1. npm install
2. npm run prepare
3. npm run dev
4. npm test

## Do and don’t
Do
- Add tests for every src file.
- Use src/common for types/constants.
- Keep functions pure.

Don’t
- Put tests under src/__tests__.
- Add inline config.
- Log PII or secrets.

## References
- docs/structure-tree.md
- docs/testing/strategy.md
- docs/workflows/ci.md

Last updated: 2025-01-04
